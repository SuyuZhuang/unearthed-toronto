{% extends "header.html" %}

{% block title %}Home{% endblock %}




{% block style %}
h3, p{
	color:#999999;
}

.container {
	width: 100%;
	padding: 0;
}

.container-fluid {
	width: 100%;
}

/* Style page content - use this if you want to push the page content to the right when you open the side navigation */
#mapid {
    transition: margin-right .5s;
}
{% endblock %}


{% block page_header %}
{% endblock %}

{% block content %}
	<div id="mySidenav" class="sidenav">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
		<a href="#">Option 1</a>
		<a href="#">Option 2</a>
		<a href="#">Option 3</a>
		<a id='mine_id' style='display:none'>67817</a>
		<a id='update-fav'>Set as Favourite</a>
	</div>


	<!-- <div style="text-align: center; width: 100%; margin: 30px auto auto auto;">
		<h1>Beautiful Map</h1>
		<h3>An interactive map that displays mining activity.</h3>
	</div> -->

	<div id="mapid" style="height: 700px;"></div>

<!--<script src="{{ url_for('static', filename='js/map.js') }}"></script>-->
<script>
	$('#update-fav').click(function() {
		$.ajax({
			url: 'update_fav',
			data: {
				id : $('#mine_id').text()
			},
			type: "GET",
			complete: function(data) {
				alert(data.responseJSON.status);
				if (data.responseJSON.status == 'Added Favorite') {
					$('#update-fav').text("Remove from Favourites")
				} else {
					$('#update-fav').text("Set as Favourite")
				}
			}
		})
	});

	function vertical_resize() {
		var h = $(window).height() - 90;
		$('.sidenav').height(h);
		//alert($('#mySidenav').height());
		$('#mapid').height(h);
	}

	window.onload = vertical_resize;

	// initialize map and set zoom
	var mymap = L.map('mapid').setView([39.526, -115.94], 10);

	// add tiles
	L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/outdoors-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZGxpbjE3IiwiYSI6ImNpcmsyMGxudzAwMnlmYm5icXlzYWsxd2IifQ.MUxIcntS8U8rRa41fbPo_Q', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);

	// on click do stuff
	function onClick(e) {
		var mine_id = e.target.feature.properties.id
		console.log("Doing stuff for " + mine_id);
		
		$.ajax({
			url: 'is_fav',
			data: {
				id: mine_id 
			},
			type: "GET",
			complete: function(data) {
				if (data.responseJSON.status == 1) {
					$('#update-fav').text("Remove from Favourites")
				} else {
					$('#update-fav').text("Set as Favourite")
				}
			}
		})

		$('#mine_id').text(mine_id)

		openNav();
		
	};

	/* Set the width of the side navigation to 250px */
	function openNav() {
		document.getElementById("mySidenav").style.width = "400px";
		document.getElementById("mapid").style.marginRight = "400px";
	}

	/* Set the width of the side navigation to 0 */
	function closeNav() {
		document.getElementById("mySidenav").style.width = "0";
		document.getElementById("mapid").style.marginRight = "0";
	}

	// define popup and action for each marker
	function onEachFeature(feature, layer) {
		// does this feature have a property named popupContent?
		if (feature.properties && feature.properties.name) {
			layer.bindPopup('<center>' + feature.properties.name + '<br>' +
							feature.properties.activity + '<br>' +
							feature.properties.owner + '</center>').on('click', onClick);
		}

		var greenIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
			shadowSize: [0,0],
			iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
		});

		var greyIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
			shadowSize: [0,0],
			iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
		});

		var orangeIcon = new L.Icon({
			iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
			shadowSize: [0,0],
			iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
		});
		
		if (feature.properties.fav > 1) {
			layer.setIcon(orangeIcon)
		} else if (feature.properties.activity == 'Inactive') {
			layer.setIcon(greyIcon)
		} else {
			layer.setIcon(greenIcon)
		}


		layer.on('mouseover', function(e) {
			this.openPopup();
		});

		layer.on('mouseout', function(e) {
			this.closePopup();
		});

		mymap.on('click', onClick_close)

		function onClick_close(e) {
			closeNav();
		}

		
	}

	// initialize marker layer
	var markers = L.geoJSON(false, {
					onEachFeature: onEachFeature
				}).addTo(mymap);

	// load markers based on map bounds
	function loadMarkers() {
		var bounds = mymap.getBounds();
		var ne = bounds._northEast;
		var sw = bounds._southWest;

		// make call to get geoJSON of all mines in view
		$.ajax({
			url: 'mines_api',
			data: { 
					minlat : sw.lat,
					minlng : sw.lng,
					maxlat : ne.lat,
					maxlng : ne.lng
				},
			type: "GET",
			async: false,
			dataType: 'json',
			complete: function(data) {
				markers.clearLayers();
				
				markers.addData(data.responseJSON);                            
			}
		})
	}

	loadMarkers();

	// add button to render mines
	L.easyButton('fa-refresh', function(){
		loadMarkers();
	}).addTo(mymap);

	
</script>

{% endblock %}
